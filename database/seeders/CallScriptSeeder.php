<?php

namespace Database\Seeders;

use App\Models\CallScript;
use App\Models\CallQuestionnaire;
use App\Models\User;
use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;

class CallScriptSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        $admin = User::role('admin')->first();
        
        if (!$admin) {
            $this->command->info('No admin user found. Make sure to run UserRoleSeeder first.');
            return;
        }

        // Создаем первый скрипт
        $script1 = CallScript::create([
            'title' => 'Базовый скрипт обзвона клиентов по ремонту трансформаторов',
            'content' => $this->getBasicScript(),
            'is_active' => true,
            'created_by' => $admin->id
        ]);

        // Анкета для первого скрипта
        CallQuestionnaire::create([
            'call_script_id' => $script1->id,
            'title' => 'Базовая анкета для клиентов',
            'is_active' => true,
            'questions' => [
                [
                    'text' => 'Заинтересован ли клиент в услуге?',
                    'type' => 'radio',
                    'options' => ['Да', 'Нет', 'Требуется дополнительная информация'],
                    'required' => true
                ],
                [
                    'text' => 'Какие услуги интересуют клиента?',
                    'type' => 'checkbox',
                    'options' => ['Услуга 1', 'Услуга 2', 'Услуга 3', 'Другое'],
                    'required' => true
                ],
                [
                    'text' => 'Как клиент узнал о компании?',
                    'type' => 'select',
                    'options' => ['Интернет', 'Реклама', 'От знакомых', 'Другое'],
                    'required' => true
                ],
                [
                    'text' => 'Комментарии клиента',
                    'type' => 'text',
                    'required' => false
                ],
                [
                    'text' => 'Приоритет для последующего обзвона',
                    'type' => 'radio',
                    'options' => ['Высокий', 'Средний', 'Низкий'],
                    'required' => true
                ]
            ]
        ]);

        // Создаем второй скрипт
        $script2 = CallScript::create([
            'title' => 'Скрипт повторного обзвона по ремонту трансформаторов',
            'content' => $this->getFollowUpScript(),
            'is_active' => true,
            'created_by' => $admin->id
        ]);

        // Анкета для второго скрипта
        CallQuestionnaire::create([
            'call_script_id' => $script2->id,
            'title' => 'Анкета обратной связи',
            'is_active' => true,
            'questions' => [
                [
                    'text' => 'Оценка качества обслуживания (от 1 до 5)',
                    'type' => 'select',
                    'options' => ['1', '2', '3', '4', '5'],
                    'required' => true
                ],
                [
                    'text' => 'Возникли ли проблемы с услугой?',
                    'type' => 'radio',
                    'options' => ['Да', 'Нет'],
                    'required' => true
                ],
                [
                    'text' => 'Если да, какие проблемы возникли?',
                    'type' => 'text',
                    'required' => false
                ],
                [
                    'text' => 'Что можно улучшить в нашем сервисе?',
                    'type' => 'text',
                    'required' => false
                ],
                [
                    'text' => 'Планирует ли клиент пользоваться услугами в будущем?',
                    'type' => 'radio',
                    'options' => ['Да', 'Нет', 'Возможно'],
                    'required' => true
                ]
            ]
        ]);
    }

    /**
     * Get basic call script template
     */
    private function getBasicScript(): string
    {
        return <<<'EOT'
СКРИПТ ОБЗВОНА КЛИЕНТОВ ПО РЕМОНТУ ТРАНСФОРМАТОРОВ

1. ПРИВЕТСТВИЕ
----------------
Здравствуйте! Меня зовут [Ваше Имя], я представляю компанию "Трансформер-CRM" – сервисный центр по ремонту и обслуживанию трансформаторного оборудования. 
Могу я поговорить с [Имя Клиента/Техническим специалистом]?

[Если разговариваете с нужным человеком] - Отлично, спасибо!
[Если нет] - Подскажите, пожалуйста, когда я могу с ним/ней связаться? Или может быть, есть другой специалист, отвечающий за обслуживание трансформаторного оборудования?

2. УСТАНОВЛЕНИЕ КОНТАКТА
------------------------
[Имя Клиента], я звоню по поводу [обслуживания трансформаторного оборудования/уточнения деталей заявки/плановой диагностики]. 
У вас есть несколько минут, чтобы обсудить данный вопрос?

[Если нет] - Когда вам будет удобно, чтобы я перезвонил?
[Если да] - Благодарю за ваше время!

3. ВЫЯВЛЕНИЕ ПОТРЕБНОСТЕЙ
-------------------------
Скажите, какое трансформаторное оборудование используется на вашем предприятии?
- Силовые трансформаторы (какой мощности?)
- Распределительные трансформаторы
- Измерительные трансформаторы
- Специальные трансформаторы

Как давно проводилось последнее техническое обслуживание?

Наблюдаются ли какие-либо проблемы в работе оборудования?
- Повышенный шум
- Перегрев
- Утечка масла
- Срабатывание защиты
- Нестабильность параметров
- Другие признаки неисправности

4. ПРЕЗЕНТАЦИЯ УСЛУГ
-------------------
Наша компания специализируется на:
- Диагностике трансформаторного оборудования
- Капитальном и текущем ремонте трансформаторов
- Замене масла и регенерации изоляции
- Модернизации систем охлаждения и защиты
- Поставке запасных частей и комплектующих
- Сервисном обслуживании по договору
- Аварийных выездах для быстрого устранения неполадок

Мы работаем с трансформаторами отечественного и импортного производства всех типов мощности.

5. РАБОТА С ВОЗРАЖЕНИЯМИ
------------------------
[Если "У нас есть свои специалисты"] - Понимаю. Наша компания может стать надежным партнером ваших специалистов, предоставляя специализированные услуги и оборудование, которое может отсутствовать у вас.

[Если "Нам это не интересно"] - Могу я узнать, как вы сейчас решаете вопросы обслуживания трансформаторного оборудования?

[Если "Слишком дорого"] - Мы предлагаем различные варианты сотрудничества, учитывая бюджет заказчика. Кроме того, своевременное обслуживание помогает избежать дорогостоящих аварийных ремонтов.

6. ЗАВЕРШЕНИЕ И ПЛАНИРОВАНИЕ СЛЕДУЮЩЕГО ШАГА
--------------------------------------------
По итогам нашего разговора я бы предложил:
- Организовать выезд наших специалистов для диагностики оборудования
- Направить вам коммерческое предложение с перечнем услуг и стоимостью
- Пригласить вас на техническую консультацию в наш сервисный центр
- Запланировать онлайн-встречу для более детального обсуждения с нашими инженерами

Какой вариант был бы для вас оптимальным?

7. ФИНАЛЬНОЕ ЗАКРЫТИЕ
---------------------
Отлично! Я запланирую [выезд инженера/отправку КП/встречу] на [дата и время]. 

Для подготовки мне нужна следующая информация:
- Точный адрес объекта
- Контактное лицо на месте
- Типы и количество трансформаторов

Я отправлю вам письмо с подтверждением всех деталей. Если возникнут вопросы до нашей встречи, вы можете связаться со мной по телефону [Ваш Номер] или написать на почту [Ваш Email].

Спасибо за уделенное время! До связи!
EOT;
    }

    /**
     * Get follow-up call script template
     */
    private function getFollowUpScript(): string
    {
        return <<<'EOT'
СКРИПТ ПОВТОРНОГО ОБЗВОНА ПО РЕМОНТУ ТРАНСФОРМАТОРОВ

1. ПРИВЕТСТВИЕ
----------------
Здравствуйте, [Имя Клиента]! Меня зовут [Ваше Имя], компания "Трансформер-CRM". 
Звоню, чтобы узнать о результатах [недавней диагностики/проведенных работ/использования нашего оборудования].

2. ПРОВЕРКА УДОВЛЕТВОРЕННОСТИ
----------------------------
Как работает ваше оборудование после [проведенных работ]?
Заметили ли вы улучшения в работе трансформаторов после нашего вмешательства?
Возникли ли какие-либо новые вопросы или проблемы?

3. СБОР ИНФОРМАЦИИ О ТЕКУЩЕМ СОСТОЯНИИ
---------------------------------------
Как часто вы проводите техническое обслуживание трансформаторов?
Ведётся ли журнал технического состояния оборудования?
Какие параметры оборудования вы контролируете регулярно?
- Температура масла
- Уровень изоляции
- Состояние контактов
- Работа систем охлаждения

4. ПРЕДЛОЖЕНИЕ ДОПОЛНИТЕЛЬНЫХ УСЛУГ
-----------------------------------
Основываясь на нашем разговоре, я бы рекомендовал:
- Регулярное техническое обслуживание (каждые 6/12 месяцев)
- Установку системы удалённого мониторинга состояния трансформатора
- Модернизацию системы охлаждения для повышения энергоэффективности
- Замену изоляционного масла
- Обучение ваших специалистов правилам эксплуатации оборудования

5. ПЛАНИРОВАНИЕ ДАЛЬНЕЙШЕГО СОТРУДНИЧЕСТВА
------------------------------------------
Предлагаю:
- Составить график планового обслуживания на год
- Заключить договор на аварийное обслуживание с гарантированным временем прибытия
- Разработать программу модернизации имеющегося оборудования
- Провести следующую диагностику трансформаторов через [период времени]

6. ЗАВЕРШЕНИЕ РАЗГОВОРА
-----------------------
Благодарю за обратную связь! На основании нашего разговора я подготовлю [предложение/документы/график] и направлю вам в течение [срок].

Если у вас возникнут вопросы или потребуется срочная консультация, вы всегда можете связаться со мной или с нашей диспетчерской службой, которая работает круглосуточно по номеру [Номер службы поддержки].

Всего доброго, до связи!
EOT;
    }
} 